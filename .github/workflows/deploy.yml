name: Deploy โ Vercel Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permite trigger manual desde GitHub UI

# Solo un deploy a la vez
concurrency:
  group: deploy-production
  cancel-in-progress: false  # No cancelar deploys en vuelo

jobs:
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # Deploy a Vercel (automรกtico desde main)
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  deploy:
    name: ๐ Deploy a Vercel
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout cรณdigo
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull configuraciรณn de Vercel
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build en Vercel
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy a producciรณn
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "โ Deployed to: $URL"

      - name: Comentar URL en el commit (opcional)
        if: success()
        run: |
          echo "๐ Deployment exitoso"
          echo "URL: ${{ steps.deploy.outputs.url }}"

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # Notificaciรณn de fallo (opcional โ requiere SLACK_WEBHOOK secret)
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  notify-failure:
    name: ๐ฃ Notificar fallo
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Log fallo
        run: |
          echo "โ Deploy fallรณ en branch ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Autor: ${{ github.actor }}"
